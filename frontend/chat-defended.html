<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat (Defended) - LLMSec Demo</title>
    <!-- UPDATED BY CLAUDE: Link to shared CSS -->
    <link rel="stylesheet" href="/static/common.css">
</head>
<body>
    <div class="container">
        <h1>üõ°Ô∏è LLMSec Demo</h1>
        <p class="subtitle">Vulnerable vs. Defended LLM Integration Patterns</p>

        <!-- UPDATED BY CLAUDE: Navigation bar -->
        <nav class="navbar">
            <a href="/">Home</a>
            <a href="/static/chat-vuln.html">Chat (Vuln)</a>
            <a href="/static/chat-defended.html" class="active">Chat (Defended)</a>
            <a href="/static/rag-vuln.html">RAG (Vuln)</a>
            <a href="/static/rag-defended.html">RAG (Defended)</a>
            <a href="/static/learn.html">Learn</a>
            <button id="theme-toggle" class="theme-toggle" onclick="toggleTheme()">‚òÄÔ∏è Light Mode</button>
        </nav>

        <!-- UPDATED BY CLAUDE: Chat Defended Card -->
        <div class="card">
            <h2 class="defended">‚úÖ Chat (Defended) - POST /chat/defended</h2>

            <div class="label">Message:</div>
            <textarea id="in" placeholder="Try: TOOL_REQUEST {&quot;name&quot;:&quot;read_file&quot;,&quot;args&quot;:{&quot;path&quot;:&quot;hello.txt&quot;}}">What can you help me with?</textarea>

            <!-- UPDATED BY CLAUDE: User confirmation checkbox -->
            <div style="margin-top: 10px;">
                <label>
                    <input type="checkbox" id="userConfirmed">
                    <span style="color: #e0e0e0;">Require user confirmation (sends user_confirmed: true)</span>
                </label>
            </div>

            <button onclick="sendRequest()">Send to Defended Endpoint</button>

            <div class="label" style="margin-top: 20px;">Raw Response JSON:</div>
            <pre id="out" style="display: none;">Waiting for response...</pre>

            <div class="label">Parsed Answer:</div>
            <div id="answer" class="response" style="display: none;">N/A</div>

            <div class="label">Tool Result:</div>
            <pre id="tool" style="display: none;">N/A</pre>
        </div>

        <!-- UPDATED BY CLAUDE: Logs section -->
        <div class="logs">
            <h2 style="color: #4c6ef5; margin-bottom: 15px;">üìä Recent Logs</h2>
            <button onclick="fetchLogs()">Refresh Logs</button>
            <button onclick="clearLogs()">Clear Logs</button>
            <pre id="logs" style="margin-top: 15px;">Loading logs...</pre>
        </div>
    </div>

    <!-- UPDATED BY CLAUDE: Link to shared JavaScript -->
    <script src="/static/common.js"></script>

    <!-- UPDATED BY CLAUDE: Page-specific JavaScript -->
    <script>
        async function sendRequest() {
            const text = document.getElementById('in').value;
            const userConfirmed = document.getElementById('userConfirmed').checked;
            const outElem = document.getElementById('out');
            const answerElem = document.getElementById('answer');
            const toolElem = document.getElementById('tool');

            // Show loading state
            outElem.textContent = 'Loading...';
            outElem.style.display = 'block';
            answerElem.textContent = 'Loading...';
            answerElem.style.display = 'block';
            toolElem.style.display = 'none';

            try {
                // UPDATED BY CLAUDE: Send with both 'user' and 'message' keys for compatibility
                const payload = {
                    user: text,
                    message: text,
                    user_confirmed: userConfirmed
                };

                const data = await safeFetch('/chat/defended', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // Display raw JSON
                outElem.textContent = JSON.stringify(data, null, 2);

                // Display parsed answer with blocking info
                if (data.blocked) {
                    answerElem.textContent = `üö´ BLOCKED\n\nReason: ${data.message || 'Injection detected'}\nHits: ${JSON.stringify(data.hits || [])}`;
                } else {
                    answerElem.textContent = data.response || data.answer || 'N/A';
                    if (data.message) {
                        answerElem.textContent += '\n\nüìù ' + data.message;
                    }
                }

                // Display tool result if present
                if (data.tool_result) {
                    toolElem.textContent = JSON.stringify(data.tool_result, null, 2);
                    toolElem.style.display = 'block';
                } else {
                    toolElem.style.display = 'none';
                }

                // Refresh logs
                await fetchLogs();
            } catch (err) {
                outElem.textContent = `Error: ${err.message}`;
                answerElem.textContent = `Error: ${err.message}`;
            }
        }
    </script>
</body>
</html>
